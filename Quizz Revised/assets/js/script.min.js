var user_response = [false, false, false, false, false];

function swipe_next_question() {
    var e = $(".question-feed .question");
    let i = e.length,
        n = $(".question-feed .question").siblings(".active").index();
    n < i - 1 && ($(e[n]).removeClass("active"), $(e[n + 1]).addClass("active"))
}

function swipe_prev_question() {
    var e = $(".question-feed .question");
    e.length;
    let i = $(".question-feed .question").siblings(".active").index();
    i > 0 && ($(e[i]).removeClass("active"), $(e[i - 1]).addClass("active"))
}

function check_answer() {
    var checked = $('.question.active .form-check .form-check-input:checked');
    var total_checked = checked.length;

    if( total_checked.length == 0 )
        return 0;

    var total_correct = $('.question.active .form-check.answer').length;
    var flag = true;

    if( total_checked >= total_correct ) {
        for( var i = 0; i < total_checked; i++ ) {
            if( !$(checked[i]).parent().hasClass('answer') ) {
                flag = false;
                break;
            }
        }

        return flag;
    }

    return -1;
}


function write_message( flag ) {
    var element = $(".message-wrapper")[0];
    if( flag == false ) {
        $(element).html('<p class="mb-0 text-danger">Wrong Answer!</p>');
    }
    else {
        $(element).html('<p class="mb-0 text-success">Correct Answer!</p>');
    }
}


function sanitize() {
    $(".message-wrapper")[0].innerHTML = "";
           
    if( $('.section.question-feed').length > 0 ) {
        if( $('.section.question-feed .question.active').index() == $('.section.question-feed .question').length - 1 ) {
            $('#finish-btn').removeClass('d-none');
            $('#next-btn').addClass('d-none');
        }
        else {
            $('#finish-btn').addClass('d-none');
            $('#next-btn').removeClass('d-none');
        }
    }
    
    var questions_cnt = $('.question-feed .question').length;
    var curr_question = $('.question-feed .question.active').index() + 1;
    $('.question-feed .question-track').text( curr_question + " / " + questions_cnt );


    $('.question.active .form-check .form-check-input').click( function() { 
        if(this.checked == true ) {
           var status = check_answer();

           if( status == true || status == false ) {
               write_message(status);
           }
        }
    });    
}

function update_answer() {
    var status = check_answer();

    if( status == true || status == false ) {
        var index = $('.question.active').index();
        user_response[index] = status;
    }
}

function update_q_board() {
    var status = check_answer();
    var index = $('.question.active').index();
        
    if( status == 0 || status == -1 ) {
        $($('.q-board .q.btn')[index]).removeClass('q-attempted');
    } 

    if( status == true || status == false ) {
        $($('.q-board .q.btn')[index]).addClass('q-attempted');
    }
}

function end_test() {
    update_answer();
    update_q_board();

    $('.arena').addClass('d-none');
    $('.result').removeClass('d-none');
    $('.end-test').removeClass('d-inline');
    $('.end-test').addClass('d-none');

    var correct = 0;
    for( var i = 0; i < user_response.length; i++ ) {
        if( user_response[i] == true )
            correct++;
    }

    var percent = parseInt( correct * 100 / user_response.length );
    var verdict = percent >= 75? true: false;

    $('.q-count').text( user_response.length );
    $('.q-correct').text( correct );
    $('.percent').text( percent + "%"  );
    $('.verdict').text( verdict ? "PASS" : "FAIL" );
    $('.percent, .verdict').addClass( verdict? "text-success": "text-danger" );
}

$('.end-test').click(function() {
    end_test();
});

$("#proceed-btn").click(function() {
    window.location.href = "/test-sections.html"
});

$("#next-btn").click(function() {
    update_answer();
    update_q_board();
    swipe_next_question();
    sanitize()
});

$("#prev-btn").click(function() {
    update_answer();
    update_q_board();
    swipe_prev_question();
    sanitize()
});


$('.q-board .q.btn').click( function() {
    update_answer();
    update_q_board();
    
    var index = $(this).parent().index();
    var e = $(".question-feed .question");
    let i = e.length,
        n = $(".question-feed .question").siblings(".active").index();
    n < i && ($(e[n]).removeClass("active"), $(e[index]).addClass("active"))

    sanitize();
});


$('#finish-btn').click( function() {
    end_test();
});

sanitize();
